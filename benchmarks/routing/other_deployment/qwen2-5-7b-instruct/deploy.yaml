apiVersion: apps/v1
kind: Deployment
metadata:
  name: qwen2-5-7b-instruct
  labels:
    model.aibrix.ai/name: qwen2-5-7b-instruct
    model.aibrix.ai/port: "8000"
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      model.aibrix.ai/name: qwen2-5-7b-instruct
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      annotations:
        vci.vke.volcengine.com/pod-ip-family: dualstack  # 主网卡使用的协议栈。
        prometheus.io/scrape: "true"  # 配置为 true 表示开启服务发现
        prometheus.io/port: "8000"  # 配置为采集指标暴露的端口号，该端口号必须在容器的配置中显示声明
        prometheus.io/path: "/metrics" # 填写指标暴露的 URI 路径，一般是 /metrics
      labels:
        model.aibrix.ai/name: qwen2-5-7b-instruct
    spec:
      affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: machine.cluster.vke.volcengine.com/gpu-name
                      operator: In
                      values:
                        - NVIDIA-L20
      containers:
        - name: vllm-openai
          image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/vllm-openai:v0.6.5
          # image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/vllm-openai:v0.6.2-distributed
          imagePullPolicy: IfNotPresent
          command:
            - python3
            - -m
            - vllm.entrypoints.openai.api_server
            - --port
            - "8000"
            - --model
            - /models/Qwen2.5-7B-Instruct/
            - --served-model-name
            - qwen2-5-7b-instruct
            - --trust-remote-code
            - --api-key
            - sk-kFJ12nKsFVfVmGpj3QzX65s4RbN2xJqWzPYCjYu7wT3BlbLi
            # - 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
            - --enable-prefix-caching
#            - --distributed-executor-backend
#            - ray
#            - --tensor-parallel-size
#            - "1"
          lifecycle:
            preStop:
              exec:
                command:
                - /bin/sh
                - -c
                - |
                  while true; do
                    RUNNING=$(curl -s http://localhost:8000/metrics | grep 'vllm:num_requests_running' | grep -v '#' | awk '{print $2}')
                    WAITING=$(curl -s http://localhost:8000/metrics | grep 'vllm:num_requests_waiting' | grep -v '#' | awk '{print $2}')
                    if [ "$RUNNING" = "0.0" ] && [ "$WAITING" = "0.0" ]; then
                      echo "Terminating: No active or waiting requests, safe to terminate" >> /proc/1/fd/1
                      exit 0
                    else
                      echo "Terminating: Running: $RUNNING, Waiting: $WAITING" >> /proc/1/fd/1
                      sleep 5
                    fi
                  done
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 90
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          ports:
            - containerPort: 8000
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 90
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              nvidia.com/gpu: "1"
            requests:
              nvidia.com/gpu: "1"
          # We need to use dataset cache
          volumeMounts:
            - mountPath: /models
              name: model-hostpath
            - name: dshm
              mountPath: /dev/shm
        - name: aibrix-runtime
          # image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.1.1
          image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.0
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 3
            periodSeconds: 2
            successThreshold: 1
            timeoutSeconds: 1
          command:
            - aibrix_runtime
            - --port
            - "8080"
          env:
            - name: INFERENCE_ENGINE
              value: vllm
            - name: INFERENCE_ENGINE_ENDPOINT
              value: http://localhost:8000
          ports:
            - containerPort: 8080
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ready
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          volumeMounts:
            - mountPath: /models
              name: model-hostpath
      initContainers:
        - name: init-model
          image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.1.1
          # image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.0 # (gangmuk): this is crashing. I can't figure out why.
          imagePullPolicy: IfNotPresent
          command:
            - aibrix_download
            - --model-uri
            - tos://aibrix-artifact-testing/models/Qwen2.5-7B-Instruct/
            - --local-dir
            - /models/
          env:
            - name: DOWNLOADER_MODEL_NAME
              value: Qwen2.5-7B-Instruct
            - name: DOWNLOADER_NUM_THREADS
              value: "16"
            - name: DOWNLOADER_ALLOW_FILE_SUFFIX
              value: json, safetensors
            - name: TOS_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: tos-credential
                  key: TOS_ACCESS_KEY
            - name: TOS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: tos-credential
                  key: TOS_SECRET_KEY
            - name: TOS_ENDPOINT
              value: tos-cn-beijing.ivolces.com
              # value: https://tos-s3-cn-beijing.ivolces.com # ?
            - name: TOS_REGION
              value: cn-beijing
          volumeMounts:
            - mountPath: /models
              name: model-hostpath
      volumes:
        - name: model-hostpath
          hostPath:
            path: /root/models
            type: DirectoryOrCreate
        - name: dshm
          emptyDir:
            medium: Memory
            sizeLimit: "4Gi"